<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gráfico — Regiões / Censo 2010 vs 2022</title>
    <script src="https://cdn.plot.ly/plotly-3.2.0.min.js"></script>

    <style>
      html,
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #222;
      }

      .wrap {
        display: flex;
        flex-direction: column;
        gap: 14px;
        position: relative;
        padding: 20px;
        transition: background-color 0.5s ease;
        overflow: visible;
      }

      .wrap h2 {
        font-size: 1.3rem;
        font-weight: 800;
        color: #004d9d;
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .wrap p.source {
        font-size: 0.85rem;
        color: #666;
        margin: 0;
      }

      #plot {
        width: 100%;
        height: 30.5em;
        transition: opacity 0.6s ease, transform 0.6s ease;
      }

      /* Botões de ano e filtros */
      button {
        color: #fff;
        border: 0;
        padding: 6px 14px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ccc;
      }

      button.active {
        transform: scale(0.95);
        box-shadow: 0 3px 0px rgba(0, 0, 0, 0.08);
      }

      /* Botões */
      button.year-2010.active {
        background: linear-gradient(90deg, #004d9d, #002766);
      }

      button.year-2022.active {
        background: linear-gradient(90deg, #b9dbff, #99c2ff);
      }

      button.year-both.active {
        background: linear-gradient(90deg, #004d9d, #b9dbff);
      }

      button.region.active.year-2010 {
        background: linear-gradient(90deg, #004d9d, #002766);
      }

      button.region.active.year-2022 {
        background: linear-gradient(90deg, #b9dbff, #99c2ff);
      }

      button.region.active.year-both {
        background: linear-gradient(90deg, #004d9d, #b9dbff);
      }

      button:hover {
        filter: brightness(1.1);
      }

      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 5px;
      }

      .region-filters {
        display: flex;
        flex-wrap: nowrap;
        gap: 8px;
        margin-top: 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 5px;
      }

      .region-filters::-webkit-scrollbar {
        display: none;
      }

      .region-filters button {
        flex: 0 0 auto;
        white-space: nowrap;
      }
      .region-scroll-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
      }

      .arrow-btn {
        display: none;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(90deg, #004d9d, #0066cc);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        z-index: 5;
        font-size: 0.8rem;
        text-align: center;
        padding-bottom: 0.5em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .arrow-btn:hover {
        transform: translateY(-50%) scale(1.1);
        filter: brightness(1.15);
      }

      .arrow-btn.left {
        left: 4px;
      }

      .arrow-btn.right {
        right: 4px;
      }

      @media (max-width: 640px) {
        #plot {
          height: 55vh;
        }

        .wrap > div:first-child {
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        .controls {
          justify-content: center;
          flex-wrap: nowrap;
          gap: 8px;
          overflow-x: auto;
        }

        .controls button {
          flex: 0 0 auto;
          white-space: nowrap;
        }

        .region-filters {
          gap: 6px;
          margin: 0 50px;
          padding: 0.5em;
          border: 2px solid #004d9d;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0, 77, 157, 0.1);
        }

        .region-filters button {
          padding: 6px 12px;
          font-size: 0.85rem;
        }
        .arrow-btn {
          display: flex;
          align-self: center;
          justify-content: center;
          align-items: center;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="wrap bg-all" id="wrap-container">
      <div
        style="
          display: flex;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 12px;
          align-items: center;
        "
      >
        <div>
          <h2 id="chart-title">População por Região — Censo 2010 × 2022</h2>
          <p class="source">
            Fonte: IBGE / Consolidação Municipal (Censo 2010 e 2022).
          </p>
        </div>
        <div class="controls">
          <button id="show-both" class="year-both active">
            <i class="fa-solid fa-layer-group"></i>Todos
          </button>
          <button id="show-2022" class="year-2022">
            <i class="fa-solid fa-chart-column"></i> 2022
          </button>
          <button id="show-2010" class="year-2010">
            <i class="fa-solid fa-chart-bar"></i> 2010
          </button>
        </div>
      </div>
      <div class="region-scroll-container">
        <button class="arrow-btn left" id="scroll-left">&#9664;</button>
        <div class="region-filters" id="region-filters"></div>
        <button class="arrow-btn right" id="scroll-right">&#9654;</button>
      </div>

      <div id="plot"></div>
    </div>
    <script>
      // Função para ler CSV
      async function carregarCSV(url) {
        const response = await fetch(url);
        const csvText = await response.text();

        const linhas = csvText.split("\n").filter((l) => l.trim() !== "");
        const cabecalho = linhas[0].split(";");

        const data2010 = [];
        const data2022 = [];

        for (let i = 1; i < linhas.length; i++) {
          const cols = linhas[i].split(";");
          const total2010 = Number(cols[5].replace(/\./g, ""));
          const total2022 = Number(cols[11].replace(/\./g, ""));
          data2010.push(total2010);
          data2022.push(total2022);
        }

        return { data2010, data2022 };
      }

      (function () {
        const wrap = document.getElementById("wrap-container");
        const regions = [
          "Centro",
          "Leste",
          "Norte",
          "Oeste",
          "Sudeste",
          "Sul",
          "Rural",
        ];
        const data2010 = [72115, 160990, 59800, 41161, 45800, 233536, 15237];
        const data2022 = [72401, 181463, 61780, 64482, 62541, 237572, 15372];
        const total2022 = data2022.reduce((a, b) => a + b, 0);
        const criancas0a14 = 128855;
        const idosos65Mais = 80504;

        let selectedYear = "both";
        let selectedRegions = [...regions];

        function makeTraces(filteredRegions) {
          // Filtra os índices das regiões selecionadas
          const indices = regions
            .map((r, i) => (filteredRegions.includes(r) ? i : -1))
            .filter((i) => i !== -1);

          const filteredNames = indices.map((i) => regions[i]);
          const y2010 = indices.map((i) => data2010[i]);
          const y2022 = indices.map((i) => data2022[i]);

          const trace2010 = {
            x: filteredNames,
            y: y2010,
            name: "Censo 2010",
            type: "bar",
            marker: {
              color: "#004d9d",
              line: { width: 1.5, color: "#003366" },
            },
            text: y2010.map(
              (n) =>
                `${n.toLocaleString("pt-BR")} (${(
                  (n / total2022) *
                  100
                ).toFixed(1)}%)`
            ),
            textposition: "auto",
            hovertemplate: "%{x}<br><b>2010:</b> %{text}<extra></extra>",
            hoverlabel: { bgcolor: "#004d9d", font: { color: "#fff" } },
          };

          const trace2022 = {
            x: filteredNames,
            y: y2022,
            name: "Censo 2022",
            type: "bar",
            marker: { color: "#b9dbff", line: { width: 1, color: "#004d9d" } },
            text: y2022.map((n, i) => {
              const diff = n - y2010[i];
              const sign = diff >= 0 ? "+" : "";
              return `${n.toLocaleString("pt-BR")} (${(
                (n / total2022) *
                100
              ).toFixed(1)}%) (${sign}${diff})`;
            }),
            textposition: "auto",
            hovertemplate: "%{x}<br><b>2022:</b> %{text}<extra></extra>",
            hoverlabel: {
              bgcolor: "#b9dbff",
              bordercolor: "#004d9d",
              font: { color: "#000" },
            },
          };

          if (selectedYear === "2010") return [trace2010];
          if (selectedYear === "2022") return [trace2022];
          return [trace2010, trace2022];
        }

        const layout = {
          barmode: "group",
          margin: { t: 40, r: 16, l: 50, b: 40 },
          legend: { orientation: "h", y: -0.15 },
          xaxis: { tickangle: 0, automargin: true },
          yaxis: { tickformat: ",d" },
          hovermode: "closest",
          font: {
            family: "Segoe UI, Tahoma, Geneva, Verdana, sans-serif",
            color: "#222",
            size: 10,
          },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          transition: { duration: 600, easing: "cubic-in-out" },
          showlegend: false,
        };

        const config = {
          responsive: true,
          displaylogo: false,
          displayModeBar: false,
        };

        // Primeiro cria o gráfico
        Plotly.newPlot("plot", makeTraces(selectedRegions), layout, config);

        // Função de atualização
        function updatePlot() {
          const traces = makeTraces(selectedRegions);

          Plotly.react("plot", traces, layout, config).then(() => {
            Plotly.animate(
              "plot",
              {
                data: traces,
                traces: [0, 1],
                layout: {
                  transition: {
                    duration: 600,
                    easing: "cubic-in-out",
                  },
                },
              },
              {
                transition: {
                  duration: 600,
                  easing: "cubic-in-out",
                },
                frame: {
                  duration: 500,
                  redraw: false,
                },
              }
            );
          });
        }

        // Botões de ano
        const btnBoth = document.getElementById("show-both");
        const btn2010 = document.getElementById("show-2010");
        const btn2022 = document.getElementById("show-2022");
        const yearButtons = [btnBoth, btn2010, btn2022];

        function selectYear(btn, year) {
          selectedYear = year;
          selectedRegions = [...regions];
          yearButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          const filterBtns = document.querySelectorAll(
            "#region-filters button"
          );
          filterBtns.forEach((b) => {
            b.classList.add("active");
            b.classList.remove("year-2010", "year-2022", "year-both");
            b.classList.add(`year-${year}`);
          });

          updatePlot();
        }

        btnBoth.addEventListener("click", () => selectYear(btnBoth, "both"));
        btn2010.addEventListener("click", () => selectYear(btn2010, "2010"));
        btn2022.addEventListener("click", () => selectYear(btn2022, "2022"));

        // Filtros de regiões
        const filterContainer = document.querySelectorAll("#region-filters")[0];
        regions.forEach((region) => {
          const btn = document.createElement("button");
          btn.textContent = region;
          btn.classList.add("region", "active", "year-both");
          btn.addEventListener("click", () => {
            if (selectedRegions.includes(region)) {
              selectedRegions = selectedRegions.filter((r) => r !== region);
              btn.classList.remove("active");
            } else {
              selectedRegions.push(region);
              btn.classList.add("active");
            }
            updatePlot();
          });
          filterContainer.appendChild(btn);
        });

        // Responsividade do texto nas barras
        function adjustTextPosition() {
          const w = document.getElementById("plot").clientWidth;
          const pos = w < 460 ? "outside" : "auto";
          updatePlot();
        }
        window.addEventListener("resize", debounce(adjustTextPosition, 150));
        function debounce(fn, wait) {
          let t;
          return function () {
            clearTimeout(t);
            t = setTimeout(fn, wait);
          };
        }

        // Comunicação com o parent
        window.parent.postMessage(
          {
            type: "updateDemographics",
            total: total2022,
            criancas: criancas0a14,
            idosos: idosos65Mais,
            regioes: regions.map((nome, i) => ({ nome, valor: data2022[i] })),
          },
          "*"
        );
      })();

      // Rolagem com as setas no mobile
      const scrollContainer = document.querySelectorAll("#region-filters")[0];
      const btnLeft = document.getElementById("scroll-left");
      const btnRight = document.getElementById("scroll-right");

      btnLeft.addEventListener("click", () => {
        scrollContainer.scrollBy({ left: -100, behavior: "smooth" });
      });

      btnRight.addEventListener("click", () => {
        scrollContainer.scrollBy({ left: 100, behavior: "smooth" });
      });
    </script>
  </body>
</html>